<div class="w-full max-w-md mx-auto">
  <h2 class="text-2xl font-bold text-gray-900 mb-6">買い物メモを編集</h2>

  <%= form_with model: @memo, url: memo_path(@memo), method: :patch, html: { class: "space-y-4" } do |f| %>
    <% if @memo.errors.any? %>
      <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-md mb-4">
        <h3 class="font-semibold mb-2">
          <%= pluralize(@memo.errors.count, "件のエラー") %>があります：
        </h3>
        <ul class="list-disc list-inside">
          <% @memo.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div>
      <%= f.label :title, "タイトル（任意）", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.text_field :title, placeholder: "例: 週末の買い物", class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" %>
    </div>

    <div>
      <%= f.label :reason, "なんで買うのか（任意）", class: "block text-sm font-medium text-gray-700 mb-1" %>
      <%= f.text_area :reason, rows: 3, placeholder: "例: 週末に家族で料理するため", class: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" %>
    </div>

    <div id="items-container" class="space-y-3">
      <%= f.fields_for :items do |item_form| %>
        <div class="item-field flex items-center space-x-2">
          <%= item_form.hidden_field :id if item_form.object.persisted? %>
          <%= item_form.text_field :name, placeholder: "例: にんじん", class: "flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" %>
          <%= item_form.number_field :quantity, min: 1, value: item_form.object.quantity || 1, class: "w-16 px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-center" %>
          <button type="button" class="remove-item text-red-600 hover:text-red-700 px-2 py-2" style="display: none;">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      <% end %>
    </div>

    <div>
      <button type="button" id="add-item-button" class="w-full text-sm text-indigo-600 hover:text-indigo-500 py-2 border border-indigo-300 rounded-md hover:bg-indigo-50">
        + アイテムを追加
      </button>
    </div>

    <div class="actions pt-4">
      <%= f.submit "更新", class: "w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" %>
    </div>
  <% end %>

  <div class="mt-4 text-center">
    <%= link_to "戻る", root_path, class: "text-sm text-indigo-600 hover:text-indigo-500" %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('items-container');
    const addItemButton = document.getElementById('add-item-button');
    let itemIndex = <%= @memo.items.reject(&:marked_for_destruction?).size %>;

    // アイテム追加
    addItemButton.addEventListener('click', function() {
      const newItemField = document.createElement('div');
      newItemField.className = 'item-field flex items-center space-x-2';
      newItemField.innerHTML = `
        <input type="text" name="memo[items_attributes][${itemIndex}][name]" placeholder="例: にんじん" class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
        <input type="number" name="memo[items_attributes][${itemIndex}][quantity]" min="1" value="1" class="w-16 px-2 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 text-center">
        <button type="button" class="remove-item text-red-600 hover:text-red-700 px-2 py-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;
      itemsContainer.appendChild(newItemField);
      itemIndex++;

      // 削除ボタンの表示/非表示を更新
      updateRemoveButtons();
    });

    // アイテム削除
    itemsContainer.addEventListener('click', function(e) {
      if (e.target.closest('.remove-item')) {
        e.preventDefault();
        const itemField = e.target.closest('.item-field');
        const hiddenIdField = itemField.querySelector('input[type="hidden"][name*="[id]"]');
        if (hiddenIdField) {
          // 既存のItemの場合は_destroyフラグを設定
          const nameAttr = hiddenIdField.name;
          const baseName = nameAttr.replace(/\[id\]$/, '');
          // 既存の_destroyフィールドがあるか確認
          let destroyField = itemField.querySelector('input[type="hidden"][name*="[_destroy]"]');
          if (!destroyField) {
            destroyField = document.createElement('input');
            destroyField.type = 'hidden';
            destroyField.name = baseName + '[_destroy]';
            destroyField.value = '1';
            itemField.appendChild(destroyField);
          }
          // 入力欄を非表示にする
          itemField.style.display = 'none';
        } else {
          // 新規追加のItemの場合は削除
          itemField.remove();
        }
        updateRemoveButtons();
      }
    });

    // 削除ボタンの表示/非表示を更新
    function updateRemoveButtons() {
      const itemFields = itemsContainer.querySelectorAll('.item-field:not([style*="display: none"])');
      itemFields.forEach(function(field) {
        const removeButton = field.querySelector('.remove-item');
        if (itemFields.length > 1) {
          removeButton.style.display = 'block';
        } else {
          removeButton.style.display = 'none';
        }
      });
    }

    // 初期表示時に削除ボタンの表示/非表示を設定
    updateRemoveButtons();
  });
</script>

